<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard de Vendas Pro</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        :root {
            --bg-primary: #f5f7fa;
            --bg-card: white;
            --text-primary: #2d3748;
            --text-secondary: #718096;
            --accent: #667eea;
            --success: #48bb78;
            --danger: #f56565;
            --shadow: 0 10px 30px rgba(0,0,0,0.1);
            --warning: #ed8936;
            --info: #4299e1;
            --purple: #9f7aea;
        }
        
        [data-theme="dark"] {
            --bg-primary: #1a202c;
            --bg-card: #2d3748;
            --text-primary: #e2e8f0;
            --text-secondary: #a0aec0;
            --shadow: 0 10px 30px rgba(0,0,0,0.5);
        }
        
        * { margin: 0; padding: 0; box-sizing: border-box; }
        
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: var(--bg-primary);
            color: var(--text-primary);
            min-height: 100vh;
            padding: 15px;
            transition: all 0.3s;
        }
        
        .container { max-width: 1400px; margin: 0 auto; }
        
        .header {
            background: var(--bg-card);
            padding: 20px;
            border-radius: 15px;
            margin-bottom: 20px;
            box-shadow: var(--shadow);
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
            gap: 15px;
        }
        
        .header h1 { color: var(--accent); font-size: clamp(18px, 4vw, 28px); }
        .header-right { display: flex; gap: 10px; }
        
        .theme-toggle, .notif-btn {
            background: var(--accent);
            color: white;
            border: none;
            padding: 10px 15px;
            border-radius: 8px;
            cursor: pointer;
            font-weight: bold;
        }
        
        .stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 15px;
            margin-bottom: 20px;
        }
        
        .stat-card {
            background: var(--bg-card);
            padding: 20px;
            border-radius: 12px;
            box-shadow: var(--shadow);
        }
        
        .stat-card h3 {
            color: var(--text-secondary);
            font-size: 11px;
            margin-bottom: 8px;
            text-transform: uppercase;
        }
        
        .stat-card .value {
            font-size: clamp(20px, 4vw, 32px);
            font-weight: bold;
            color: var(--accent);
        }
        
        .charts-section {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
            gap: 20px;
            margin-bottom: 20px;
        }
        
        .chart-card {
            background: var(--bg-card);
            padding: 20px;
            border-radius: 12px;
            box-shadow: var(--shadow);
        }
        
        .tabs {
            background: var(--bg-card);
            padding: 20px;
            border-radius: 12px;
            box-shadow: var(--shadow);
            margin-bottom: 20px; 
        }
        
        .tab-buttons { display: flex; gap: 10px; margin-bottom: 20px; flex-wrap: wrap; }
        
        .tab-button {
            padding: 10px 20px;
            border: none;
            background: #e2e8f0;
            border-radius: 8px;
            cursor: pointer;
            font-weight: bold;
            color: var(--text-primary);
        }
        
        .tab-button.active { background: var(--accent); color: white; }
        
        .tab-content { display: none; }
        .tab-content.active { display: block; }
        
        table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 15px;
            font-size: 14px;
        }
        
        th {
            background: var(--accent);
            color: white;
            padding: 12px 10px;
            text-align: left;
        }
        
        td {
            padding: 12px 10px;
            border-bottom: 1px solid #e2e8f0;
        }
        
        tbody tr { cursor: pointer; transition: background-color 0.2s; }
        tbody tr:hover { background-color: rgba(102, 126, 234, 0.1); }

        .status {
            padding: 4px 10px;
            border-radius: 12px;
            font-size: 11px;
            font-weight: bold;
            text-align: center;
            display: inline-block;
            min-width: 80px;
        }
        
        .status.pendente { background: var(--warning); color: white; }
        .status.entregue { background: var(--success); color: white; }
        .status.em\.separa√ß√£o { background: var(--info); color: white; }
        .status.aguardando\.entregador { background: var(--purple); color: white; }
        .status.a\.caminho { background: var(--accent); color: white; }
        
        .status-pagamento.pago { background: var(--success); color: white; }
        .status-pagamento.pendente { background: var(--danger); color: white; }
        
        .refresh-btn {
            position: fixed;
            bottom: 20px;
            right: 20px;
            background: var(--accent);
            color: white;
            border: none;
            padding: 12px 20px;
            border-radius: 30px;
            cursor: pointer;
            font-weight: bold;
            box-shadow: 0 4px 12px rgba(102, 126, 234, 0.4);
            z-index: 1000;
        }
        
        .loading { text-align: center; padding: 30px; color: var(--text-secondary); }
        
        .spinner {
            border: 3px solid #e2e8f0;
            border-top: 3px solid var(--accent);
            border-radius: 50%;
            width: 30px;
            height: 30px;
            animation: spin 1s linear infinite;
            margin: 15px auto;
        }
        
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }

        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.6);
            display: none;
            justify-content: center;
            align-items: center;
            z-index: 2000;
        }
        .modal-content {
            background: var(--bg-card);
            padding: 25px;
            border-radius: 15px;
            width: 90%;
            max-width: 500px;
            box-shadow: 0 5px 25px rgba(0,0,0,0.3);
            animation: slideUp 0.3s ease-out;
        }
        @keyframes slideUp { from { transform: translateY(30px); opacity: 0; } to { transform: translateY(0); opacity: 1; } }
        .modal-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; }
        .modal-header h2 { color: var(--accent); }
        .modal-close-btn { font-size: 24px; cursor: pointer; background: none; border: none; color: var(--text-primary); }
        .modal-body p { margin-bottom: 12px; line-height: 1.6; }
        .modal-body strong { color: var(--accent); }
        .modal-footer { margin-top: 25px; display: flex; gap: 10px; justify-content: flex-end; }
        #statusEntregaSelect, #statusPagamentoSelect, .modal-input {
            width: 100%;
            padding: 10px;
            border-radius: 8px;
            border: 1px solid #e2e8f0;
            margin-bottom: 15px;
            background: var(--bg-primary);
            color: var(--text-primary);
        }
        .modal-btn {
            padding: 10px 20px;
            border-radius: 8px;
            border: none;
            cursor: pointer;
            font-weight: bold;
        }
        .btn-save { background: var(--success); color: white; }
        .btn-cancel { background: #e2e8f0; color: var(--text-primary); }
        
        @media (max-width: 768px) {
            body { padding: 10px; }
            .stats { grid-template-columns: repeat(auto-fit, minmax(130px, 1fr)); gap: 10px; }
        }
    </style>
</head>
<body data-theme="light">
    <div class="container">
        <div class="header">
            <div>
                <h1>Dashboard de Vendas Pro</h1>
                <p style="color: var(--text-secondary); font-size: 13px;">Atualiza√ß√£o a cada 30s</p>
            </div>
            <div class="header-right">
                <button class="notif-btn" id="notifBtn" onclick="toggleNotif()">üîî ON</button>
                <button class="theme-toggle" onclick="toggleTheme()">üåô</button>
            </div>
        </div>

        <div class="tabs">
            <div class="tab-buttons">
                <button class="tab-button active" onclick="mudarTab('pedidos', event)">Pedidos</button>
                <button class="tab-button" onclick="mudarTab('estoque', event)">Estoque</button>
            </div>
            
            <div id="pedidos" class="tab-content active">
                <h2>Pedidos Recentes</h2>
                <div id="tabelaPedidos"><div class="loading"><div class="spinner"></div><p>Carregando...</p></div></div>
            </div>
            
            <div id="estoque" class="tab-content">
                <h2>Controle de Estoque</h2>
                <div id="tabelaEstoque"><div class="loading"><div class="spinner"></div><p>Carregando...</p></div></div>
            </div>
        </div>
        
        <div class="stats">
            <div class="stat-card"><h3>Pedidos Hoje</h3><div class="value" id="pedidosHoje">0</div></div>
            <div class="stat-card"><h3>Faturamento</h3><div class="value" id="faturamentoHoje">R$ 0</div></div>
            <div class="stat-card"><h3>Ticket M√©dio</h3><div class="value" id="ticketMedio">R$ 0</div></div>
            <div class="stat-card"><h3>Estoque</h3><div class="value" id="produtosEstoque">0</div></div>
        </div>
        
        <div class="charts-section">
            <div class="chart-card"><h3>Vendas 7 Dias</h3><canvas id="vendasChart"></canvas></div>
            <div class="chart-card"><h3>Top Produtos</h3><canvas id="produtosChart"></canvas></div>
        </div>
        
        <button class="refresh-btn" onclick="carregarDados()">üîÑ</button>
    </div>

    <div id="pedidoModal" class="modal-overlay">
        <div class="modal-content">
            <div class="modal-header">
                <h2 id="modalTitle">Detalhes do Pedido</h2>
                <button class="modal-close-btn" onclick="fecharModal('pedidoModal')">√ó</button>
            </div>
            <div class="modal-body">
                <p><strong>Cliente:</strong> <span id="modalCliente"></span></p>
                <p><strong>Telefone:</strong> <span id="modalTelefone"></span></p>
                <p><strong>Endere√ßo:</strong> <span id="modalEndereco"></span></p>
                <p><strong>Produtos:</strong><br><span id="modalProdutos"></span></p>
                <p><strong>Total:</strong> <span id="modalTotal"></span></p>
                <p><strong>Pagamento:</strong> <span id="modalPagamento"></span></p>
                <hr style="margin: 15px 0; border-color: #e2e8f0;">
                
                <label for="statusEntregaSelect" style="font-weight: bold; margin-bottom: 8px; display: block;">Status Entrega:</label>
                <select id="statusEntregaSelect">
                    <option value="Pendente">Pendente</option>
                    <option value="Em separa√ß√£o">Em separa√ß√£o</option>
                    <option value="Aguardando entregador">Aguardando entregador</option>
                    <option value="A caminho">A caminho</option>
                    <option value="Entregue">Entregue</option>
                </select>

                <label for="statusPagamentoSelect" style="font-weight: bold; margin-bottom: 8px; display: block;">Status Pagamento:</label>
                <select id="statusPagamentoSelect">
                    <option value="Pendente">Pendente</option>
                    <option value="Pago">Pago</option>
                </select>

                <input type="hidden" id="modalPedidoId">
            </div>
            <div class="modal-footer">
                <button class="modal-btn btn-cancel" onclick="fecharModal('pedidoModal')">Cancelar</button>
                <button class="modal-btn btn-save" id="btnSalvarStatus" onclick="salvarAlteracoesPedido()">Salvar Altera√ß√µes</button>
            </div>
        </div>
    </div>

    <div id="estoqueModal" class="modal-overlay">
        <div class="modal-content">
            <div class="modal-header">
                <h2 id="modalEstoqueTitle">Atualizar Estoque</h2>
                <button class="modal-close-btn" onclick="fecharModal('estoqueModal')">√ó</button>
            </div>
            <div class="modal-body">
                <p><strong>Produto:</strong> <span id="modalProdutoNome"></span></p>
                <label for="quantidadeInput" style="font-weight: bold; margin-bottom: 8px; display: block;">Nova Quantidade:</label>
                <input type="number" id="quantidadeInput" class="modal-input" placeholder="Digite a nova quantidade total">
                <input type="hidden" id="modalProdutoId">
            </div>
            <div class="modal-footer">
                <button class="modal-btn btn-cancel" onclick="fecharModal('estoqueModal')">Cancelar</button>
                <button class="modal-btn btn-save" id="btnSalvarEstoque" onclick="salvarEstoque()">Salvar</button>
            </div>
        </div>
    </div>
    
    <script>
        const API_URL = 'https://script.google.com/macros/s/AKfycbweFtbPYe7KJfSuEy5w8dyPoFW7vWHVI3AGt5V3zAWvkddllHqz_KLzX-mEGyDwxpxKkQ/exec';
        let pedidosCache = [];
        let estoqueCache = [];
        let vendasChart, produtosChart;
        let notifEnabled = true;

        async function carregarDados() {
            try {
                document.getElementById('tabelaPedidos').innerHTML = '<div class="loading"><div class="spinner"></div><p>Carregando...</p></div>';
                document.getElementById('tabelaEstoque').innerHTML = '<div class="loading"><div class="spinner"></div><p>Carregando...</p></div>';

                await Promise.all([carregarPedidos(), carregarEstoque()]);
                calcularStats();
                criarGraficos();
            } catch (error) {
                console.error('Erro geral ao carregar dados:', error);
                document.getElementById('tabelaPedidos').innerHTML = `<p style="text-align:center;padding:30px;color:red;">Falha ao carregar pedidos. Verifique o console do navegador (F12) para mais detalhes.</p>`;
            }
        }
        
        async function carregarPedidos() {
            const res = await fetch(`${API_URL}?action=getPedidos&_t=${Date.now()}`);
            if (!res.ok) throw new Error(`HTTP error! status: ${res.status}`);
            const data = await res.json();
            pedidosCache = data.pedidos || [];
            
            if (pedidosCache.length === 0) {
                document.getElementById('tabelaPedidos').innerHTML = '<p style="text-align:center;padding:30px">Nenhum pedido</p>';
                return;
            }
            
            let html = '<table><thead><tr><th>ID</th><th>Hor√°rio</th><th>Cliente</th><th>Total</th><th>Status Entrega</th><th>Status Pagamento</th></tr></thead><tbody>';
            pedidosCache.slice().reverse().slice(0, 20).forEach(p => {
                const statusEntregaClass = (p.status || 'pendente').toLowerCase().replace(/ /g, '.');
                const statusPagamentoClass = (p.statusPagamento || 'pendente').toLowerCase();
                html += `<tr onclick="abrirModalPedido(${p.id})">
                    <td>#${p.id}</td>
                    <td>${new Date(p.data).toLocaleTimeString('pt-BR', {hour: '2-digit', minute: '2-digit'})}</td>
                    <td>${p.nome || 'N√£o identificado'}</td>
                    <td>R$ ${(p.total || 0).toFixed(2)}</td>
                    <td><span class="status ${statusEntregaClass}">${p.status || 'Pendente'}</span></td>
                    <td><span class="status status-pagamento ${statusPagamentoClass}">${p.statusPagamento || 'Pendente'}</span></td>
                </tr>`;
            });
            html += '</tbody></table>';
            document.getElementById('tabelaPedidos').innerHTML = html;
        }
        
        function abrirModalPedido(pedidoId) {
            const pedido = pedidosCache.find(p => p.id === pedidoId);
            if (!pedido) return;

            document.getElementById('modalTitle').textContent = `Detalhes do Pedido #${pedido.id}`;
            document.getElementById('modalCliente').textContent = pedido.nome || 'N√£o identificado';
            document.getElementById('modalTelefone').textContent = pedido.telefone || 'N√£o informado';
            document.getElementById('modalEndereco').textContent = pedido.endereco || 'N√£o informado';
            document.getElementById('modalProdutos').innerHTML = pedido.produto.replace(/\n/g, '<br>');
            document.getElementById('modalTotal').textContent = `R$ ${(pedido.total || 0).toFixed(2)}`;
            document.getElementById('modalPagamento').textContent = `${pedido.formaPagamento} (Troco: ${pedido.troco})`;
            
            document.getElementById('statusEntregaSelect').value = pedido.status || 'Pendente';
            document.getElementById('statusPagamentoSelect').value = pedido.statusPagamento || 'Pendente';

            document.getElementById('modalPedidoId').value = pedido.id;
            document.getElementById('pedidoModal').style.display = 'flex';
        }

        function fecharModal(modalId) {
            document.getElementById(modalId).style.display = 'none';
        }

        async function salvarAlteracoesPedido() {
            const pedidoId = document.getElementById('modalPedidoId').value;
            const novoStatusEntrega = document.getElementById('statusEntregaSelect').value;
            const novoStatusPagamento = document.getElementById('statusPagamentoSelect').value;
            const btn = document.getElementById('btnSalvarStatus');
            btn.textContent = 'Salvando...';
            btn.disabled = true;

            try {
                const res = await fetch(`${API_URL}?action=updatePedido`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'text/plain' },
                    body: JSON.stringify({ 
                        id: pedidoId, 
                        status: novoStatusEntrega,
                        statusPagamento: novoStatusPagamento 
                    })
                });
                const result = await res.json();

                if (result.success) {
                    fecharModal('pedidoModal');
                    await carregarDados(); 
                } else {
                    alert('Erro ao atualizar o pedido: ' + (result.error || 'Erro desconhecido'));
                }
            } catch (error) {
                alert('Falha na comunica√ß√£o com o servidor.');
                console.error("Erro ao salvar altera√ß√µes: ", error);
            } finally {
                btn.textContent = 'Salvar Altera√ß√µes';
                btn.disabled = false;
            }
        }
        
        async function carregarEstoque() { try { const res = await fetch(`${API_URL}?action=getEstoque&_t=${Date.now()}`); if (!res.ok) throw new Error(`HTTP error! status: ${res.status}`); const data = await res.json(); estoqueCache = data.produtos || []; if (estoqueCache.length === 0) { document.getElementById('tabelaEstoque').innerHTML = '<p style="text-align:center;padding:30px">Sem produtos</p>'; return; } let html = '<table><thead><tr><th>ID</th><th>Produto</th><th>Pre√ßo</th><th>Qtd</th></tr></thead><tbody>'; estoqueCache.forEach(p => { const cor = p.quantidade < 5 ? 'color:var(--danger);font-weight:bold;' : ''; html += `<tr onclick="abrirModalEstoque(${p.id}, '${p.nome.replace(/'/g, "\\'")}', ${p.quantidade})"><td>${p.id}</td><td>${p.nome}</td><td>R$ ${p.preco.toFixed(2)}</td><td style="${cor}">${p.quantidade}</td></tr>`; }); html += '</tbody></table>'; document.getElementById('tabelaEstoque').innerHTML = html; document.getElementById('produtosEstoque').textContent = estoqueCache.reduce((sum, p) => sum + p.quantidade, 0); } catch(e) { console.error("Erro em carregarEstoque:", e); } }
        function abrirModalEstoque(id, nome, qtd) { document.getElementById('modalProdutoNome').textContent = nome; document.getElementById('quantidadeInput').value = qtd; document.getElementById('modalProdutoId').value = id; document.getElementById('estoqueModal').style.display = 'flex'; }
        async function salvarEstoque() { const produtoId = document.getElementById('modalProdutoId').value; const novaQuantidade = document.getElementById('quantidadeInput').value; const btn = document.getElementById('btnSalvarEstoque'); if (novaQuantidade === '' || isNaN(novaQuantidade) || novaQuantidade < 0) { alert('Por favor, insira uma quantidade v√°lida.'); return; } btn.textContent = 'Salvando...'; btn.disabled = true; try { const res = await fetch(`${API_URL}?action=setEstoque`, { method: 'POST', headers: { 'Content-Type': 'text/plain' }, body: JSON.stringify({ id: produtoId, quantidade: parseInt(novaQuantidade) }) }); const result = await res.json(); if (result.success) { fecharModal('estoqueModal'); await carregarDados(); } else { alert('Erro ao atualizar o estoque: ' + (result.error || 'Erro desconhecido')); } } catch (error) { alert('Falha na comunica√ß√£o com o servidor.'); console.error("Erro ao salvar estoque: ", error); } finally { btn.textContent = 'Salvar'; btn.disabled = false; } }
        function calcularStats() { const hoje = new Date(); hoje.setHours(0, 0, 0, 0); const pedidosHoje = pedidosCache.filter(p => { const d = new Date(p.data); d.setHours(0, 0, 0, 0); return d.getTime() === hoje.getTime(); }); const total = pedidosHoje.reduce((sum, p) => sum + (p.total || 0), 0); const ticket = pedidosHoje.length > 0 ? total / pedidosHoje.length : 0; document.getElementById('pedidosHoje').textContent = pedidosHoje.length; document.getElementById('faturamentoHoje').textContent = `R$ ${total.toFixed(2)}`; document.getElementById('ticketMedio').textContent = `R$ ${ticket.toFixed(2)}`; }
        function criarGraficos() { const dias = []; const vendas = []; for (let i = 6; i >= 0; i--) { const d = new Date(); d.setDate(d.getDate() - i); d.setHours(0, 0, 0, 0); dias.push(d.toLocaleDateString('pt-BR', { day: '2-digit', month: '2-digit' })); const count = pedidosCache.filter(p => { const pd = new Date(p.data); pd.setHours(0, 0, 0, 0); return pd.getTime() === d.getTime(); }).length; vendas.push(count); } const ctxVendas = document.getElementById('vendasChart').getContext('2d'); if (vendasChart) vendasChart.destroy(); vendasChart = new Chart(ctxVendas, { type: 'line', data: { labels: dias, datasets: [{ label: 'Pedidos', data: vendas, borderColor: '#667eea', backgroundColor: 'rgba(102, 126, 234, 0.1)', tension: 0.4 }] }, options: { responsive: true, maintainAspectRatio: true, plugins: { legend: { display: false } } } }); const produtosCount = {}; pedidosCache.forEach(p => { const produtos = p.produto.split('\n'); produtos.forEach(prod => { const nome = prod.split('x ')[1]; if (nome) { produtosCount[nome] = (produtosCount[nome] || 0) + 1; } }); }); const top5 = Object.entries(produtosCount).sort((a, b) => b[1] - a[1]).slice(0, 5); const ctxProdutos = document.getElementById('produtosChart').getContext('2d'); if (produtosChart) produtosChart.destroy(); produtosChart = new Chart(ctxProdutos, { type: 'doughnut', data: { labels: top5.map(p => p[0]), datasets: [{ data: top5.map(p => p[1]), backgroundColor: ['#667eea', '#48bb78', '#ed8936', '#f56565', '#9f7aea'] }] }, options: { responsive: true, maintainAspectRatio: true } }); }
        toggleTheme = () => { document.body.setAttribute('data-theme', document.body.getAttribute('data-theme') === 'light' ? 'dark' : 'light'); }
        toggleNotif = () => { notifEnabled = !notifEnabled; document.getElementById('notifBtn').textContent = notifEnabled ? 'üîî ON' : 'üîî OFF'; }
        mudarTab = (tab, e) => { document.querySelectorAll('.tab-button').forEach(b => b.classList.remove('active')); document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active')); e.target.classList.add('active'); document.getElementById(tab).classList.add('active'); }
        
        carregarDados();
        setInterval(carregarDados, 30000);
    </script>
</body>
</html>
